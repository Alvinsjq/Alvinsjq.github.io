<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> 8086寄存器以及实模式和保护模式 | Alvin Is </title> <!-- Icons --> <link rel="apple-touch-icon" type=" image/png" sizes="144x144" href="assets/images/webicon.png"> <link rel="icon" type=" image/png" href="/assets/images/webicon_32.png"> <link rel="shortcut icon" type=" image/png" href="/assets/images/webicon_32.png"> <meta name="description" content=" MIT6828实验1的基础知识，包括两份参考资料，介绍早期处理器的一些特点... "> <meta name="keywords" content="OS"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Alvinsjq"> <meta property="article:section" content=""> <meta property="article:tag" content="OS"> <meta property="article:published_time" content="2017-02-10 13:00:58 +0800"> <meta property="og:url" content="http://alvinsjq.github.io/2017/80x86/"> <meta property="og:title" content=" 8086寄存器以及实模式和保护模式 | Alvin Is "> <meta property="og:image" content="http://alvinsjq.github.io"> <meta property="og:description" content=" MIT6828实验1的基础知识，包括两份参考资料，介绍早期处理器的一些特点... "> <meta property="og:site_name" content="Alvinsjq"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@Alvin_sjq"> <meta name="twitter:title" content=" 8086寄存器以及实模式和保护模式 | Alvin Is "> <meta name="twitter:description" content=" MIT6828实验1的基础知识，包括两份参考资料，介绍早期处理器的一些特点... "> <meta name="twitter:image:src" content="http://alvinsjq.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" 8086寄存器以及实模式和保护模式 | Alvin Is "> <meta itemprop="description" content=" MIT6828实验1的基础知识，包括两份参考资料，介绍早期处理器的一些特点... "> <meta itemprop="image" content="http://alvinsjq.github.io"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="/assets/css/font-awesome.min.css"> <!-- Canonical link tag --> <link rel="canonical" href="http://alvinsjq.github.io/2017/80x86/"> <link rel="alternate" type="application/rss+xml" title="Alvin Is" href="http://alvinsjq.github.io/feed.xml"> <script type="text/javascript"> var disqus_shortname = 'alvin-is'; var _gaq = _gaq || []; _gaq.push(['_setAccount', '']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script> <script>AV.initialize("OfIL1RlM4M4n30dWx3wXlEIz-gzGzoHsz", "LlDtB3Xu9be1655lnGQdPedO");</script> <script> function showHitCount(Counter) { var query = new AV.Query(Counter); var entries = []; var $visitors = $(".leancloud_visitors"); $visitors.each(function () { entries.push( $(this).attr("id").trim() ); }); query.containedIn('url', entries); query.find() .done(function (results) { var COUNT_CONTAINER_REF = '.leancloud-visitors-count'; if (results.length === 0) { $visitors.find(COUNT_CONTAINER_REF).text(0); return; } for (var i = 0; i < results.length; i++) { var item = results[i]; var url = item.get('url'); var hits = item.get('hits'); var element = document.getElementById(url); $(element).find(COUNT_CONTAINER_REF).text(hits); } for(var i = 0; i < entries.length; i++) { var url = entries[i]; var element = document.getElementById(url); var countSpan = $(element).find(COUNT_CONTAINER_REF); if( countSpan.text() == '') { countSpan.text(0); } } }) .fail(function (object, error) { console.log("Error: " + error.code + " " + error.message); }); } function addCount(Counter) { var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); query.equalTo("url", url); query.find({ success: function(results) { if (results.length > 0) { var counter = results[0]; counter.fetchWhenSave(true); counter.increment("hits"); counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); $element.find('.leancloud-visitors-count').text(counter.get('hits')); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { var newcounter = new Counter(); var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); newcounter.set("title", title); newcounter.set("url", url); newcounter.set("hits", 1); newcounter.save(null, { success: function(newcounter) { var $element = $(document.getElementById(url)); $element.find('.leancloud-visitors-count').text(newcounter.get('hits')); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } $(function() { var Counter = AV.Object.extend("Counter"); if ($('.leancloud_visitors').length == 1) { addCount(Counter); } else if ($('.post-link').length > 1){ showHitCount(Counter); } }); </script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?011d93aa32b263cf21d7c9a15165b8a0"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">Alvin Is<span></span></a></h1> <ul class="navbar"> <li><a href="/about">About</a></li> <li><a href="/talks">Topics</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml" target="_blank"></a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2017-02-10T13:00:58+08:00" itemprop="datePublished">Feb 10, 2017</time> <span id="/2017/80x86/" class="leancloud_visitors" data-flag-title="8086寄存器以及实模式和保护模式"> <span class="post-meta-divider">|</span> <span class="post-meta-item-text"> 浏览次数: </span> <span class="leancloud-visitors-count"></span> </span> </p> <h1 class="post-title" itemprop="name headline">8086寄存器以及实模式和保护模式</h1> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } }); </script> <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> </header> <div class="post-content" itemprop="articleBody"> <h2 id="section">本文大纲</h2> <ol> <li>关于80x86系列</li> <li>8086 16-bit 寄存器</li> <li>80386 32-bit 寄存器</li> <li>实模式</li> <li>16-bit保护模式</li> <li>32-bit保护模式</li> </ol> <p>如何看懂boot.S以及boot.c文件，需要做一些预备</p> <h4 id="x86">关于80x86系列</h4> <ul> <li> <p>8088，8086:早期PC的CPU使用，仅支持1M空间，仅在实模式（real mode）下工作。在这种模式下，程序可以访问任何内存，即使该内存是其他程序的。同时，内存被分成段，每个段不能超多64K。</p> </li> <li> <p>80286:AT系列CPU使用。新特性是16位保护模式，在这个模式下可扩至16M，并且保护程序获取其他程序的内存。段依旧不能超过64K。</p> </li> <li> <p>80386:提升了8028。拓展了许多寄存器能够支持32位，增加了两个新的16位寄存器FS和GS。新增加了32位的保护模式。在这种模式下，能获取4G空间。与此同时，段也能访问到4G。</p> </li> </ul> <h4 id="bit-">8086 16-bit 寄存器</h4> <ul> <li> <p>4个16位通用寄存器一般用于数据转移和算数指令：AX，BX，CX，DX。<br /> 每个寄存器有低8位与高8位，例如AX：AH AL</p> </li> <li> <p>2个16位索引寄存器，它们一般当作指针，和通用寄存器的目标类似，但是不能分为8位寄存器，它们是SI和DI。</p> </li> <li> <p>16位BP和SP寄存器用来指向在机器语言栈中的数据，之后会讨论到。</p> </li> <li> <p>4个段寄存器代表程序的不同部分的内存：CS代表代码段，DS代表数据段，SS代表栈段，ES代表附加段。</p> </li> <li> <p>指令指针寄存器IP与CS寄存器配合使用，追踪下一条CPU执行段指令的地址。</p> </li> <li> <p>标志寄存器，即FLAGS寄存器储存了之前指令结果的重要信息。</p> </li> </ul> <p><img src="https://github.com/Alvinsjq/6.828_tasks/blob/master/screemshot/8086.png?raw=true" alt="图：8086寄存器" /></p> <h4 id="bit--1">80386 32-bit 寄存器</h4> <p>在8086基础的拓展，例如将16位的AX拓展为32位。为了向后兼容，AX依旧是16位寄存器，EAX是拓展32位寄存器。AX是EAX的低16位，就像AL是AX的低8位一样。</p> <p>段寄存器依旧是16位，并且增加了两个新的段寄存器：FS和GS。它们和ES一样，就是额外的寄存器（备胎）。</p> <h4 id="section-1">实模式</h4> <p>在实模式下，内存只有1M大小，也就是2^20字节。对应的有效地址就是从00000到FFFFF。但是这么多的地址需要20位的数才能表示。但是对于8086的16位寄存器无法表示完整。Intel便通过两个16位的数才得到实模式下的地址。那么具体怎么得到呢，前16位的值叫做<strong>selector</strong>，<strong>selector</strong>值必须储存在段寄存器中。后16位的值叫做<strong>offset</strong>。这样物理地址就可以用一个32-bit的<strong>selector：offset</strong>来表示出来。通过一下的公式：</p> <p><code class="highlighter-rouge">16*selector+offset</code></p> <p>在16进制中乘以一个16很简单，就像在10进制中乘一个10一样，仅需要在selector后面加一个<strong>0</strong>，然后再将offset的值加上即可得到物理地址，例如</p> <p><code class="highlighter-rouge">047C：0048</code></p> <p>等于</p> <p><code class="highlighter-rouge">047C0+0048</code>，即<code class="highlighter-rouge">04808</code>。</p> <p><strong>selector</strong>是16字节的数（也就是它有 2<sup>4</sup>个地址，而每个地址有1字节内存）。当然，实段地址有一些不好的地方：</p> <blockquote> <p>一个单一的select寄存器只能检索到64K大小，上界便是16-bit的offset。那如果有一个程序，其要运行的程序有大于64K的大小，那么这和问题如何解决？</p> </blockquote> <ul> <li>即将程序分为小于64K大小的sections中，当执行从一个段到另一个段时，CS的值必须改变。在大量数据以及DS寄存器下也会发生类似的问题。</li> </ul> <p>在内存中的每个字节并不一定只有唯一的段地址。物理地址04808有可能是047C:0048, 047D:0038, 047E:0028或者047B:0058。这样段地址的比较就非常复杂。</p> <h5 id="bit">16-bit保护模式</h5> <p>在80286的16位保护模式下，selector值与实模式下的值的解释是完全不一样的。<br /> 在实模式下，selector值为paragraph memory（16字节）。<br /> 在保护模式下，selector是到描述表（descriptor table）的一个索引值（index）。<br /> 两种模式下，程序都分为段：<br /> 在实模式下，这些段在物理内存的固定地址上，selector就是段开头的paragraph数，<br /> 在保护模式下，段不再在物理内存段固定地址，事实上，它们不一定要在内存中了。</p> <p>在保护模式下，运用了一个叫做<strong>虚拟内存</strong>的技术一个虚拟内存的基本想法是，只要保证程序此时在用的数据和代码在内存中。其他的数据和代码可以暂时储存在磁盘上知道它们需要再次被使用。<br /> 在16-bit保护模式下，段在内存和磁盘之间移动：<br /> 当段从磁盘回到内存时，很有可能该段会被放在和它移动到磁盘之前的一个不同的地方。而这就时操作系统所做的。</p> <p>保护模式下，每个段在描述表中分配了一个入口。这个入口上有系统想要知道该段段所有信息：它是否还在内存；如果在，那么在哪里；允许获取（例如只读）。那么，该段入口的索引值就是存储在段寄存器里的selector值。</p> <p>不好的地方就是，offset依旧时16位的。因此段大小依旧限制在64K。</p> <h5 id="bit-1">32-bit保护模式</h5> <ul> <li> <p>386的32-bit与286的16-bit保护模式比较，有两个主要的不同：</p> </li> <li> <p>Offsets拓展到32-bits。这就允许一个offset达到4 billion，段的大小升级到4G。<br /> 段可以被分为更小的4K大小的页（pages）。虚拟内存就不再与段合作而是与页合作。</p> </li> </ul> <p><strong>注意</strong></p> <blockquote> <p>关于内存，有一些计量单位，如下表：</p> </blockquote> <table> <thead> <tr> <th>名称</th> <th style="text-align: center">含义</th> </tr> </thead> <tbody> <tr> <td>word</td> <td style="text-align: center">2 bytes</td> </tr> <tr> <td>double word</td> <td style="text-align: center">4 bytes</td> </tr> <tr> <td>quad word</td> <td style="text-align: center">8 bytes</td> </tr> <tr> <td>paragraph</td> <td style="text-align: center">16 bytes</td> </tr> </tbody> </table> <p>参考资料：</p> <ul> <li><a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/s01_02.htm">Intel 80386 Reference Programmer’s Manual Table of Contents</a></li> <li><a href="https://pdos.csail.mit.edu/6.828/2016/readings/pcasm-book.pdf">PC Assembly Language</a></li> </ul> <aside class="share"> <p>If you liked this article and think others should read it, please share it on <a href="http://twitter.com/share?text=8086寄存器以及实模式和保护模式&amp;url=http://alvinsjq.github.io/2017/80x86/&amp;via=Alvin_sjq" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter <i class="fa fa-twitter" aria-hidden="true" style="color:#00aced"></i></a>or <a href="https://www.facebook.com/sharer/sharer.php?u=http://alvinsjq.github.io/2017/80x86/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">facebook <i class="fa fa-facebook-square" aria-hidden="true" style="color:#3b5998"></i></a>.</p> </aside> </div> <style type="text/css"> .tagged { margin-top: 1rem; } .tagged a { border: 1px solid #ddd; padding: 2px 5px; background: transparent; display: inline-block; color: #999; outline: 0; text-decoration: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; font-size: 70%; } .tagged a:hover { cursor: pointer; border: 1px solid #555; background: #444; color: #fff; } .back { /*text-align: center;*/ text-transform: uppercase; letter-spacing: 1px; } </style> <div class="tagged"> <a href="http://alvinsjq.github.io/tagged#mit6-828"><i class="fa fa-hashtag" aria-hidden="true"></i>MIT6.828</a> <a href="http://alvinsjq.github.io/tagged#operating-system"><i class="fa fa-hashtag" aria-hidden="true"></i>Operating System</a> <a href="http://alvinsjq.github.io/tagged#操作系统"><i class="fa fa-hashtag" aria-hidden="true"></i>操作系统</a> <a href="http://alvinsjq.github.io/tagged#学习历程"><i class="fa fa-hashtag" aria-hidden="true"></i>学习历程</a> <a href="http://alvinsjq.github.io/tagged#6828l1"><i class="fa fa-hashtag" aria-hidden="true"></i>6828L1</a> <a href="http://alvinsjq.github.io/tagged#8086寄存器"><i class="fa fa-hashtag" aria-hidden="true"></i>8086寄存器</a> </div> <br> <div class="back"><a href="/"><i class="fa fa-chevron-left"></i>Back</a></div> </article> <aside id="comments" class="disqus"> <div class="container"> <div id="gitmentContainer"></div> <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"> <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script> <script> var gitment = new Gitment({ id: '<%= page.title %>', owner: 'Alvinsjq', repo: 'Alvinsjq.github.io', oauth: { client_id: 'b108345cd65235055f4a', client_secret: '2faaebf58d2e33a50a022d84c6448d9d9535feda', }, }); gitment.render('gitmentContainer'); </script> </div> </aside> <footer class="site-footer"> <div class="container"> <small class="block">&copy; 2018 Alvinsjq. All rights reserved.</small> <small><a href="https://github.com/heiswayi/thinkspace">Thanks for <i class="fa fa-heart" aria-hidden="true" style="color:#DD3D36"></i> Thinkspace</a> theme by <a href="http://heiswayi.github.io/">Heiswayi Nrird</a>.</small> <div class="footer-social-links"> <a href="http://alvinsjq.github.io/feed.xml" title="RSS Feed" target="_blank"><i class="fa fa-rss"></i></a> <a href="http://weibo.com/p/1005051719812480/home" title="Weibo" target="_blank"><i class="fa fa-weibo" aria-hidden="true"></i></a> <a href="https://twitter.com/Alvin_sjq" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a> <a href="https://github.com/Alvinsjq/" title="GitHub Repositories" target="_blank"><i class="fa fa-github-alt"></i></a> <a href="https://www.instagram.com/sj_alvin/" title="Instagram" target="_blank"><i class="fa fa-instagram"></i></a> </div> </div> </footer> </main> </body> </html>
