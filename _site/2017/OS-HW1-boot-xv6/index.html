<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> MIT6.828 HW 1:boot xv6 | Alvin Is </title> <!-- Icons --> <link rel="apple-touch-icon" type=" image/png" sizes="144x144" href="assets/images/webicon.png"> <link rel="icon" type=" image/png" href="/assets/images/webicon_32.png"> <link rel="shortcut icon" type=" image/png" href="/assets/images/webicon_32.png"> <meta name="description" content=" 这是课程的作业1:启动xv6操作系统。 "> <meta name="keywords" content="OS,xv6"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Alvinsjq"> <meta property="article:section" content=""> <meta property="article:tag" content="OS,xv6"> <meta property="article:published_time" content="2017-02-14 13:36:58 +0800"> <meta property="og:url" content="http://alvinsjq.github.io/2017/OS-HW1-boot-xv6/"> <meta property="og:title" content=" MIT6.828 HW 1:boot xv6 | Alvin Is "> <meta property="og:image" content="http://alvinsjq.github.io"> <meta property="og:description" content=" 这是课程的作业1:启动xv6操作系统。 "> <meta property="og:site_name" content="Alvinsjq"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@Alvin_sjq"> <meta name="twitter:title" content=" MIT6.828 HW 1:boot xv6 | Alvin Is "> <meta name="twitter:description" content=" 这是课程的作业1:启动xv6操作系统。 "> <meta name="twitter:image:src" content="http://alvinsjq.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" MIT6.828 HW 1:boot xv6 | Alvin Is "> <meta itemprop="description" content=" 这是课程的作业1:启动xv6操作系统。 "> <meta itemprop="image" content="http://alvinsjq.github.io"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="/assets/css/font-awesome.min.css"> <!-- Canonical link tag --> <link rel="canonical" href="http://alvinsjq.github.io/2017/OS-HW1-boot-xv6/"> <link rel="alternate" type="application/rss+xml" title="Alvin Is" href="http://alvinsjq.github.io/feed.xml"> <script type="text/javascript"> var disqus_shortname = 'alvin-is'; var _gaq = _gaq || []; _gaq.push(['_setAccount', '']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script> <script>AV.initialize("OfIL1RlM4M4n30dWx3wXlEIz-gzGzoHsz", "LlDtB3Xu9be1655lnGQdPedO");</script> <script> function showHitCount(Counter) { var query = new AV.Query(Counter); var entries = []; var $visitors = $(".leancloud_visitors"); $visitors.each(function () { entries.push( $(this).attr("id").trim() ); }); query.containedIn('url', entries); query.find() .done(function (results) { var COUNT_CONTAINER_REF = '.leancloud-visitors-count'; if (results.length === 0) { $visitors.find(COUNT_CONTAINER_REF).text(0); return; } for (var i = 0; i < results.length; i++) { var item = results[i]; var url = item.get('url'); var hits = item.get('hits'); var element = document.getElementById(url); $(element).find(COUNT_CONTAINER_REF).text(hits); } for(var i = 0; i < entries.length; i++) { var url = entries[i]; var element = document.getElementById(url); var countSpan = $(element).find(COUNT_CONTAINER_REF); if( countSpan.text() == '') { countSpan.text(0); } } }) .fail(function (object, error) { console.log("Error: " + error.code + " " + error.message); }); } function addCount(Counter) { var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); query.equalTo("url", url); query.find({ success: function(results) { if (results.length > 0) { var counter = results[0]; counter.fetchWhenSave(true); counter.increment("hits"); counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); $element.find('.leancloud-visitors-count').text(counter.get('hits')); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { var newcounter = new Counter(); var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); newcounter.set("title", title); newcounter.set("url", url); newcounter.set("hits", 1); newcounter.save(null, { success: function(newcounter) { var $element = $(document.getElementById(url)); $element.find('.leancloud-visitors-count').text(newcounter.get('hits')); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } $(function() { var Counter = AV.Object.extend("Counter"); if ($('.leancloud_visitors').length == 1) { addCount(Counter); } else if ($('.post-link').length > 1){ showHitCount(Counter); } }); </script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?011d93aa32b263cf21d7c9a15165b8a0"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">Alvin Is<span></span></a></h1> <ul class="navbar"> <li><a href="/about">About</a></li> <li><a href="/talks">Topics</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml" target="_blank"></a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2017-02-14T13:36:58+08:00" itemprop="datePublished">Feb 14, 2017</time> <span id="/2017/OS-HW1-boot-xv6/" class="leancloud_visitors" data-flag-title="MIT6.828 HW 1:boot xv6"> <span class="post-meta-divider">|</span> <span class="post-meta-item-text"> 浏览次数: </span> <span class="leancloud-visitors-count"></span> </span> </p> <h1 class="post-title" itemprop="name headline">MIT6.828 HW 1:boot xv6</h1> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } }); </script> <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> </header> <div class="post-content" itemprop="articleBody"> <h2 id="boot-xv6">Boot xv6</h2> <p>首先是将课程项目clone到本地</p> <div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir 6.828
$ cd 6.828
$ git clone git://github.com/mit-pdos/xv6-public.git
Cloning into 'xv6-public'...
...
$
</code></pre></div> <p>然后进入目录，</p> <div class="highlighter-rouge"><pre class="highlight"><code>$ cd xv6-public
$ make
...
gcc -O -nostdinc -I. -c bootmain.c
gcc -nostdinc -I. -c bootasm.S
ld -m    elf_i386 -N -e start -Ttext 0x7C00 -o bootblock.o bootasm.o bootmain.o
objdump -S bootblock.o &gt; bootblock.asm
objcopy -S -O binary -j .text bootblock.o bootblock
...
$ 
</code></pre></div> <p>这样就将xv6编译完毕，就可以做homework了。</p> <p>如何用<code class="highlighter-rouge">make qemu-gdb</code>和<code class="highlighter-rouge">gdb</code>命令，可以到之前的<a href="https://alvinsjq.github.io/2017/OS-Lab1/">博文</a>上找到解决方法，这里直接做homework。</p> <h2 id="section">找到地址和设置断点</h2> <p>寻找_start的地址和内核的入口地址，输入命令即可得到：</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="err">$</span> <span class="n">nm</span> <span class="n">kernel</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">_start</span>
<span class="mi">8010</span><span class="n">a48c</span> <span class="n">D</span> <span class="n">_binary_entryother_start</span>
<span class="mi">8010</span><span class="n">a460</span> <span class="n">D</span> <span class="n">_binary_initcode_start</span>
<span class="mo">0010000</span><span class="n">c</span> <span class="n">T</span> <span class="n">_start</span>
</code></pre></div> <p>然后在_start的上设置断点，并继续执行</p> <div class="highlighter-rouge"><pre class="highlight"><code>b * 0x010000c
c 
</code></pre></div> <p>接着是具体的作业练习：主要是弄清楚栈里是什么？（what is on the stack？）</p> <p>通过一下命令可以看到寄存器和栈上的数据，对所得到的结果，对非零的栈的值进行简短的解释。</p> <div class="highlighter-rouge"><pre class="highlight"><code>(gdb) info reg
...
(gdb) x/24x $esp
...
(gdb)
</code></pre></div> <p>查询<code class="highlighter-rouge">bootasm.S</code>、<code class="highlighter-rouge">bootmian.c</code>和<code class="highlighter-rouge">bootblock.asm</code>这些文件是很方便的。参考页面也有关于x86的汇编文档，如果想要弄清楚特定指令的语义就可以从那找到。作业是要在我们刚进入xv6内核之后，理解和解释上面所看到的栈的内容。有一个方法是在早期boot期间，观察stack是怎样并在哪里建立起来的并且进行追踪。以下是一些问题纲要：</p> <ol> <li>在0x7c00设置一个断点，应该可以发现这是启动的第一条指令。bootasm.S的开始执行的地方。<br /> 在<code class="highlighter-rouge">bootblock.asm</code>中可以发现</li> </ol> <div class="highlighter-rouge"><pre class="highlight"><code>    00007c00 &lt;start&gt;:
    # with %cs=0 %ip=7c00.

    .code16                      # Assemble for 16-bit mode
    .globl start
    start:
     cli                        # BIOS enabled interrupts; disable
       7c00:   fa                      cli 
</code></pre></div> <ol> <li> <p>接下来，利用gdb中的si命令单步执行。找到bootasm.S中stack pointer是在哪里初始化的？（单步执行，直到你找到某条指令把某个值移动到了%esp寄存器中。%esp也就是栈指针。)<br /> 同样通过gdb的<code class="highlighter-rouge">si</code>命令以及<code class="highlighter-rouge">bootblock.asm</code>可以看出在0x7c43处，开始初始化sp：</p> <p><code class="highlighter-rouge">c # Set up the stack pointer and call into C. movl $start, %esp 7c43: bc 00 7c 00 00 mov $0x7c00,%esp </code></p> </li> <li> <p>当代码跳转到bootmain的时候，这个时候栈里面又存放的是什么？<br /> 跳转到bootmain()时，地址为：</p> <p><code class="highlighter-rouge">c call bootmain 7c48: e8 e9 00 00 00 call 7d36 &lt;bootmain&gt; </code></p> <p>用gdb的<code class="highlighter-rouge">info reg</code>得到：</p> <p><code class="highlighter-rouge">c (gdb) si =&gt; 0x7c48: call 0x7d36 0x00007c48 in ?? () (gdb) info reg eax 0x0 0 ecx 0x0 0 edx 0x80 128 ebx 0x0 0 esp 0x7c00 0x7c00 //stack pointer指的地址 ebp 0x0 0x0 esi 0x0 0 edi 0x0 0 eip 0x7c48 0x7c48 eflags 0x6 [ PF ] cs 0x8 8 ss 0x10 16 ds 0x10 16 es 0x10 16 fs 0x0 0 gs 0x0 0 </code></p> </li> <li> <p>在bootmain里面的第一条汇编指令对这个stack做啥了？可以查看bootblock.asm，bootmain就在里面。</p> </li> </ol> <div class="highlighter-rouge"><pre class="highlight"><code>    void
    bootmain(void)
    {
        7d36:   55                      push   %ebp
        7d37:   89 e5                   mov    %esp,%ebp
        7d39:   57                      push   %edi
        7d3a:   56                      push   %esi
        7d3b:   53                      push   %ebx
        7d3c:   83 ec 1c                sub    $0x1c,%esp
        ... 
</code></pre></div> <ol> <li>查看在bootblock.asm里面的bootmain，找到调用call。这个call会把%eip指向0x10000c。这个call对栈又做了啥？</li> </ol> <p>实际上bootmain.c主要做的事情就是读取kernel，并且跳转到kernel处开始执行。加载的时候，是把kernel加载到了0x10000内存地址处。call还是把返回地址压栈了。</p> <ol> <li>提交：x/24x %esp的有效输出，应该就是说非0的那一部分，以及你的comment。把这个作业写到hwN.txt里面。N表示的是第几次作业。</li> </ol> <div class="highlighter-rouge"><pre class="highlight"><code><span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0010000c</span> <span class="n">in</span> <span class="o">??</span> <span class="p">()</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">info</span> <span class="n">reg</span>
<span class="n">eax</span>            <span class="mh">0x0</span>  <span class="mi">0</span>
<span class="n">ecx</span>            <span class="mh">0x0</span>  <span class="mi">0</span>
<span class="n">edx</span>            <span class="mh">0x1f0</span>    <span class="mi">496</span>
<span class="n">ebx</span>            <span class="mh">0x10074</span>  <span class="mi">65652</span>
<span class="n">esp</span>            <span class="mh">0x7bcc</span>   <span class="mh">0x7bcc</span>
<span class="n">ebp</span>            <span class="mh">0x7bf8</span>   <span class="mh">0x7bf8</span>
<span class="n">esi</span>            <span class="mh">0x10074</span>  <span class="mi">65652</span>
<span class="n">edi</span>            <span class="mh">0x0</span>  <span class="mi">0</span>
<span class="n">eip</span>            <span class="mh">0x10000c</span> <span class="mh">0x10000c</span>
<span class="n">eflags</span>         <span class="mh">0x46</span> <span class="p">[</span> <span class="n">PF</span> <span class="n">ZF</span> <span class="p">]</span>
<span class="n">cs</span>             <span class="mh">0x8</span>  <span class="mi">8</span>
<span class="n">ss</span>             <span class="mh">0x10</span> <span class="mi">16</span>
<span class="n">ds</span>             <span class="mh">0x10</span> <span class="mi">16</span>
<span class="n">es</span>             <span class="mh">0x10</span> <span class="mi">16</span>
<span class="n">fs</span>             <span class="mh">0x0</span>  <span class="mi">0</span>
<span class="n">gs</span>             <span class="mh">0x0</span>  <span class="mi">0</span>

<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">24</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0x7bcc</span><span class="o">:</span> <span class="mh">0x00007dbf</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
<span class="mh">0x7bdc</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
<span class="mh">0x7bec</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
<span class="mh">0x7bfc</span><span class="o">:</span> <span class="mh">0x00007c4d</span>  <span class="mh">0x8ec031fa</span>  <span class="mh">0x8ec08ed8</span>  <span class="mh">0xa864e4d0</span>
<span class="mh">0x7c0c</span><span class="o">:</span> <span class="mh">0xb0fa7502</span>  <span class="mh">0xe464e6d1</span>  <span class="mh">0x7502a864</span>  <span class="mh">0xe6dfb0fa</span>
<span class="mh">0x7c1c</span><span class="o">:</span> <span class="mh">0x16010f60</span>  <span class="mh">0x200f7c78</span>  <span class="mh">0xc88366c0</span>  <span class="mh">0xc0220f01</span>
</code></pre></div> <blockquote> <p>first commit HW1:<br /> 这里主要是C语言和汇编语言怎样调用的过程。</p> </blockquote> <aside class="share"> <p>If you liked this article and think others should read it, please share it on <a href="http://twitter.com/share?text=MIT6.828 HW 1:boot xv6&amp;url=http://alvinsjq.github.io/2017/OS-HW1-boot-xv6/&amp;via=Alvin_sjq" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter <i class="fa fa-twitter" aria-hidden="true" style="color:#00aced"></i></a>or <a href="https://www.facebook.com/sharer/sharer.php?u=http://alvinsjq.github.io/2017/OS-HW1-boot-xv6/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">facebook <i class="fa fa-facebook-square" aria-hidden="true" style="color:#3b5998"></i></a>.</p> </aside> </div> <style type="text/css"> .tagged { margin-top: 1rem; } .tagged a { border: 1px solid #ddd; padding: 2px 5px; background: transparent; display: inline-block; color: #999; outline: 0; text-decoration: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; font-size: 70%; } .tagged a:hover { cursor: pointer; border: 1px solid #555; background: #444; color: #fff; } .back { /*text-align: center;*/ text-transform: uppercase; letter-spacing: 1px; } </style> <div class="tagged"> <a href="http://alvinsjq.github.io/tagged#mit6-828"><i class="fa fa-hashtag" aria-hidden="true"></i>MIT6.828</a> <a href="http://alvinsjq.github.io/tagged#operating-system"><i class="fa fa-hashtag" aria-hidden="true"></i>Operating System</a> <a href="http://alvinsjq.github.io/tagged#操作系统"><i class="fa fa-hashtag" aria-hidden="true"></i>操作系统</a> <a href="http://alvinsjq.github.io/tagged#学习历程"><i class="fa fa-hashtag" aria-hidden="true"></i>学习历程</a> <a href="http://alvinsjq.github.io/tagged#6828hw"><i class="fa fa-hashtag" aria-hidden="true"></i>6828HW</a> <a href="http://alvinsjq.github.io/tagged#xv6"><i class="fa fa-hashtag" aria-hidden="true"></i>xv6</a> </div> <br> <div class="back"><a href="/"><i class="fa fa-chevron-left"></i>Back</a></div> </article> <aside id="comments" class="disqus"> <div class="container"> <div id="gitmentContainer"></div> <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"> <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script> <script> var gitment = new Gitment({ id: '<%= page.title %>', owner: 'Alvinsjq', repo: 'Alvinsjq.github.io', oauth: { client_id: 'b108345cd65235055f4a', client_secret: '2faaebf58d2e33a50a022d84c6448d9d9535feda', }, }); gitment.render('gitmentContainer'); </script> </div> </aside> <footer class="site-footer"> <div class="container"> <small class="block">&copy; 2018 Alvinsjq. All rights reserved.</small> <small><a href="https://github.com/heiswayi/thinkspace">Thanks for <i class="fa fa-heart" aria-hidden="true" style="color:#DD3D36"></i> Thinkspace</a> theme by <a href="http://heiswayi.github.io/">Heiswayi Nrird</a>.</small> <div class="footer-social-links"> <a href="http://alvinsjq.github.io/feed.xml" title="RSS Feed" target="_blank"><i class="fa fa-rss"></i></a> <a href="http://weibo.com/p/1005051719812480/home" title="Weibo" target="_blank"><i class="fa fa-weibo" aria-hidden="true"></i></a> <a href="https://twitter.com/Alvin_sjq" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a> <a href="https://github.com/Alvinsjq/" title="GitHub Repositories" target="_blank"><i class="fa fa-github-alt"></i></a> <a href="https://www.instagram.com/sj_alvin/" title="Instagram" target="_blank"><i class="fa fa-instagram"></i></a> </div> </div> </footer> </main> </body> </html>
